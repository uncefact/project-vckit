# Development

Copy `.env` from a co-worker or insert own credentials to get started. A copy of the .env file is available at `.env.example`

```
npm run dev
```

To run e2e tests locally:

- `npm run dev` to start the local environment
- `npm run test:e2e:local` to run the tests

Please note that the `test:e2e:local` will automatically setup the endpoint for the different API for you. Indeed the command set the environment variable `OFFLINE` to true and in jest configuration, we automatically set the endpoint address when the `OFFLINE` variable is set. You can check more in `jest.setup.js` file.

# VCKit Storage API

## Storage

This service exists to provide transient file storage to facilitate transmission via QR codes or hyperlinks.
The document is received and then encrypted by the server with the provided decryption key.
This encrypted document is returned to the API caller, along with the other encryption parameters.

Files have a default expiration date of 31 days from upload, after which it will be permanently deleted from storage and made irretrievable.

**This service currently has a limitation where uploaded files must be < 6MB, due to AWS Lambda payload limit**

#### Examples

###### Uploading a document with API key

```sh
curl --request POST \
  --url http://localhost:5000/stg/95f6287d-11f7-42e5-8cc9-aefa25e754de \
  --header 'content-type: application/json' \
  --data '{
	"document": {
  "schema": "opencerts/v2.0",
  "data": { ... },
  "privacy": {},
  "signature": {
    "type": "SHA3MerkleProof",
    "targetHash": "cbd224a72af5e0050bd58ab2264094cbacac0f19f7f430e347cad451ae8c590d",
    "proof": [],
    "merkleRoot": "cbd224a72af5e0050bd58ab2264094cbacac0f19f7f430e347cad451ae8c590d"
  }
},
  "decryptionKey": "e0df31f6ec9f1f92c6543added90416c86f40d20025661b91b2f3ee9589f5047"
}'
```

Returns:

```json
{
  "id": "95f6287d-11f7-42e5-8cc9-aefa25e754de",
  "key": "e0df31f6ec9f1f92c6543added90416c86f40d20025661b91b2f3ee9589f5047",
  "type": "OPEN-ATTESTATION-TYPE-1",
  "ttl": 1654830305079
}
```

Which means the file has been successfully uploaded and can be retrieved from http://localhost:5000/stg/95f6287d-11f7-42e5-8cc9-aefa25e754de and decrypted using the given key.

###### Retrieving an uploaded file

```sh
curl --request GET \
  --url http://localhost:5000/stg/95f6287d-11f7-42e5-8cc9-aefa25e754de
```

Will return

```json
{
  "document": {
    "cipherText": "twETH8OSgv5lOcj6J8jIcn7/CC...",
    "iv": "Qq+uDpAs4CbMpZRs",
    "tag": "ghT8WP0PxMm58oHzzdqD9w==",
    "type": "OPEN-ATTESTATION-TYPE-1",
    "ttl": 1595390482411
  }
}
```

This content can be decrypted using the [OpenAttestation encryption library](https://www.npmjs.com/package/@govtechsg/oa-encryption)

#### Configuration

###### Deploying via Pulumi locally

```
npm run build
export LOCAL_DEPLOYMENT=true
pulumi up
```

###### File Expiration

To configure the file expiration duration, please set the environment variable `OBJECT_TTL` to an integer value with the number of days. For example, `7`.

###### Access Control

To enable access control of uploading documents via API keys, please set the environment variable `ENABLE_STORAGE_UPLOAD_API_KEY` to `true`
This option is disabled by default. This access control does not include the GET function, as the document is already encrypted. Any retrieved data is unusable without the decryption key.

Upon deployment, the API key is automatically generated by AWS and printed in the console output as such:

```
...
api keys:
  stg-storage-api-key: kNb15YYZ6N1zBlYd25cjj8PLgK6YAuvN9Gf7fPM1
...
```

# VCKit Config API

Will update once implementation is approved
